<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>洗濯機・風呂メンテナンス</title>
<style>
body { font-family: sans-serif; margin:0; padding:20px; display:flex; justify-content:center; background:#eee; overflow-y:auto; }
.container { width:100%; max-width:600px; }
h1 { text-align:center; font-size:1.8em; margin-bottom:24px; }
.task-card { background:#fff; border-radius:5px; padding:20px; margin:16px 0; box-shadow:2px2px0 rgba(0,0,0,0.1); display:flex; flex-direction:column; align-items:center; }
.task-title { font-weight:bold; font-size:1.5em; margin-bottom:10px; text-align:center; letter-spacing:0.05em; }
.button-group { display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-bottom:6px; }
button { padding:10px 24px; border-radius:999px; border:none; background:#5abebb; color:white; font-size:1.1em; cursor:pointer; transition:background 0.2s; }
button:hover { background:#48aba8; }
.next-date { margin-top:5px; font-size:1.1em; text-align:center; color:#555; }
.modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9998; }
.history-modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border-radius:3px; padding:20px; box-shadow:2px2px2px rgba(0,0,0,0.2); z-index:9999; white-space:pre-line; max-width:90%; max-height:80%; overflow-y:auto; }
.history-modal button { display:block; margin:10px auto 0; padding:8px 16px; font-size:1em; border-radius:999px; border:none; background:#5abebb; color:white; cursor:pointer; }
.history-modal button:hover { background:#48aba8; }
@media(max-width:400px){ .task-title{font-size:1.3em;} button{padding:12px 20px; font-size:1em;} .next-date{font-size:1em;} }
</style>
</head>
<body>
<div class="container">
  <h1>洗濯機・風呂メンテナンス</h1>
  <div id="maintenance-list"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://cyyavrlclxparfkcwmkg.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function formatDateJP(dateLike) {
  const date = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
  return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;
}

function calculateNextDate(latestDone, task_type) {
  let date = latestDone ? new Date(latestDone) : new Date();
  if (task_type?.includes('2週間')) date.setDate(date.getDate()+14);
  else if (task_type?.includes('1.5')||task_type?.includes('1.5ヶ月')) date.setDate(date.getDate()+45);
  else if (task_type?.includes('2ヶ月')) date.setMonth(date.getMonth()+2);
  else if (task_type?.includes('3ヶ月')) date.setMonth(date.getMonth()+3);
  else if (task_type?.includes('1ヶ月')) date.setMonth(date.getMonth()+1);
  else date.setMonth(date.getMonth()+1);
  return date;
}

async function fetchTasks() {
  const { data: tasks, error: tasksError } = await supabase.from('maintenance_tasks').select('*').order('id', {ascending:true});
  if (tasksError){ console.error(tasksError); return; }
  const container = document.getElementById('maintenance-list');
  container.innerHTML = '';

  for(const task of tasks){
    const { data: historyData } = await supabase.from('maintenance_history').select('done_at').eq('task_id',task.id).order('done_at',{ascending:false}).limit(1);
    const latestDone = historyData?.[0]?.done_at || null;

    const card = document.createElement('div'); card.className='task-card';
    const title = document.createElement('div'); title.className='task-title'; title.textContent=task.task_name;

    const buttons = document.createElement('div'); buttons.className='button-group';

    const useBtn = document.createElement('button'); useBtn.textContent='実施した';
    useBtn.onclick=async()=>{
      const now = new Date();
      const { error: insertError } = await supabase.from('maintenance_history').insert({task_id:task.id, done_at:now});
      if(insertError){ console.error(insertError); return; }

      const nextDate = calculateNextDate(now, task.task_type);
      const { error: updateError } = await supabase.from('maintenance_tasks').update({next_date: nextDate.toISOString()}).eq('id',task.id);
      if(updateError){ console.error(updateError); return; }

      await fetchTasks(); // 更新表示
    };

    const historyBtn = document.createElement('button'); historyBtn.textContent='履歴';
    historyBtn.onclick=async()=>{
      const { data: hist, error: histError } = await supabase.from('maintenance_history').select('*').eq('task_id',task.id).order('done_at',{ascending:false}).limit(10);
      if(histError){ console.error(histError); return; }

      const formatted = hist.map(h=>formatDateJP(h.done_at)).join('\n')||'履歴なし';
      const overlay=document.createElement('div'); overlay.className='modal-overlay';
      const modal=document.createElement('div'); modal.className='history-modal'; modal.textContent=formatted;
      const closeBtn=document.createElement('button'); closeBtn.textContent='閉じる';
      closeBtn.onclick=()=>{ overlay.parentNode?.removeChild(overlay); modal.parentNode?.removeChild(modal); };
      modal.appendChild(document.createElement('br')); modal.appendChild(closeBtn);
      overlay.onclick=()=>{ overlay.parentNode?.removeChild(overlay); modal.parentNode?.removeChild(modal); };
      document.body.appendChild(overlay); document.body.appendChild(modal);
    };

    buttons.appendChild(useBtn); buttons.appendChild(historyBtn);

    const nextDateObj = task.next_date ? new Date(task.next_date) : calculateNextDate(latestDone, task.task_type);
    const nextDateDiv=document.createElement('div'); nextDateDiv.className='next-date'; nextDateDiv.textContent='次回: '+formatDateJP(nextDateObj);

    const now = new Date();
    const diffDays = Math.ceil((nextDateObj.setHours(0,0,0,0)-(new Date(now.getFullYear(), now.getMonth(), now.getDate())).getTime())/(1000*60*60*24));
    nextDateDiv.style.color = diffDays<0 ? 'red' : (diffDays<=7 ? 'blue' : '#555');

    card.appendChild(title); card.appendChild(buttons); card.appendChild(nextDateDiv);
    container.appendChild(card);
  }
}

fetchTasks();
</script>
</body>
</html>
